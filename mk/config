# -*- Mode: makefile -*-
#
# Script to generate a program.
# Assumes variables:
#    MFILES: root names of files
#    LMFILES: root names of library files
#    PFILES: root names of program files
#    MLLIBS: root name of libraries
#    MAIN: root name of generated program
#

#
# Config
#
ifeq ($(OSTYPE),win32)
   EXE = .exe
endif
ifeq ($(OSTYPE),cygwin32)
   EXE = .exe
endif

ifndef CAMLP4LIB
   CAMLP4LIB = /usr/local/lib/camlp4
endif

ifndef TERM
   TERM = std
endif

#
# OCAML commands
#
ifndef CAMLP4
   CAMLP4 = camlp4o$(EXE)
endif
ifndef OCAMLC
   OCAMLC = ocamlc$(EXE)
endif
ifndef OCAMLCP
   OCAMLCP = $(OCAMLC)
   OCAMLCPOPT =
endif
ifndef OCAMLMKTOP
   OCAMLMKTOP = ocamlmktop
endif
ifndef OCAMLOPT
   OCAMLOPT = ocamlopt$(EXE)
endif
ifndef PRLC
   PRLC = $(ROOT)/bin/prlc$(EXE) -lib $(ROOT)/lib
endif
ifndef INLINE
   INLINE=5
endif

#
# Use this when compiling with threads.
# This is tested only on Linux i386.
#
THREADS = -thread
LIBTHREADS = -cclib -lthreadsnat -cclib -lunix -cclib -lpthread

#
# Configuration
#
OCAMLDEP = $(ROOT)/bin/ocamldep
OCAMLCFLAGS = $(INCLUDE) $(OCAMLFLAGS) $(NOASSERT) $(THREADS)
OCAMLOPTFLAGS = $(INCLUDE) $(OCAMLFLAGS) $(PROFILE) -inline $(INLINE) -noassert $(THREADS)
CAMLP4NFLAGS = $(INCLUDE) $(OCAMLFLAGS)
CAMLP4OFLAGS = $(INCLUDE)
CFLAGS = -g -I$(CAMLLIB) -D_REENTRANT
CC = gcc
RM = rm
INSTALL = /bin/cp -pf
CP = /bin/cp -pf
CPP = /lib/cpp -traditional
LN = ln -sf
CAMLP4N = $(ROOT)/lib/camlp4n$(EXE)

# For cleaning the directory
ifdef MAIN
   CLEAN_MAIN = $(MAIN) $(MAIN).run
endif

# Library file names
MLFILES      = $(sort $(addsuffix .ml,   $(NLFILES) $(NL2FILES) $(LMFILES) $(MFILES) $(PFILES)))
MLIFILES     = $(sort $(addsuffix .mli,  $(NLFILES) $(NL2FILES) $(LMFILES) $(MFILES) $(PFILES)))

NL_CMIFILES  = $(addsuffix .cmi,  $(NLFILES))
NL_CMOFILES  = $(addsuffix .cmo,  $(NLFILES))
NL_CMIZFILES = $(addsuffix .cmiz, $(NLFILES))
NL_CMOZFILES = $(addsuffix .cmoz, $(NLFILES))
NL_CMXFILES  = $(addsuffix .cmx,  $(NLFILES))
NL_PPOFILES  = $(addsuffix .ppo,  $(NLFILES))

NL2_CMIFILES  = $(addsuffix .cmi,  $(NL2FILES))
NL2_CMOFILES  = $(addsuffix .cmo,  $(NL2FILES))
NL2_CMIZFILES = $(addsuffix .cmiz, $(NL2FILES))
NL2_CMOZFILES = $(addsuffix .cmoz, $(NL2FILES))
NL2_CMXFILES  = $(addsuffix .cmx,  $(NL2FILES))
NL2_PPOFILES  = $(addsuffix .ppo,  $(NL2FILES))

LCMOFILES    = $(addsuffix .cmo,  $(LMFILES))
LCMIFILES    = $(addsuffix .cmi,  $(LMFILES))
LCMXFILES    = $(addsuffix .cmx,  $(LMFILES))
MCMIFILES    = $(addsuffix .cmi,  $(MFILES))
MCMOFILES    = $(addsuffix .cmo,  $(MFILES))
MCMXFILES    = $(addsuffix .cmx,  $(MFILES))
PCMIFILES    = $(addsuffix .cmi,  $(PFILES))
PCMOFILES    = $(addsuffix .cmo,  $(PFILES))
PCMXFILES    = $(addsuffix .cmx,  $(PFILES))

LMLIFILES    = $(addsuffix .mli,  $(LMFILES))
LMLFILES     = $(addsuffix .ml,   $(LMFILES))
MMLFILES     = $(addsuffix .mli,  $(MFILES))
MMLIFILES    = $(addsuffix .ml,   $(MFILES))
PMLIFILES    = $(addsuffix .mli,  $(PFILES))
PMLFILES     = $(addsuffix .ml,   $(PFILES))

REG_CMIFILES = $(sort $(LCMIFILES) $(MCMIFILES) $(PCMIFILES))
REG_CMOFILES = $(sort $(LCMOFILES) $(MCMOFILES) $(PCMOFILES))
REG_CMXFILES = $(sort $(LCMXFILES) $(MCMXFILES) $(PCMXFILES))

CMIFILES     = $(sort $(NL_CMIFILES) $(NL2_CMIFILES) $(LCMIFILES) $(MCMIFILES))
CMOFILES     = $(sort $(NL_CMOFILES) $(NL2_CMOFILES) $(LCMOFILES) $(MCMOFILES))
CMXFILES     = $(sort $(NL_CMXFILES) $(NL2_CMXFILES) $(LCMXFILES) $(MCMXFILES))

CMAFILES     = $(addsuffix .cma,  $(MLLIBS))
CMXAFILES    = $(addsuffix .cmxa, $(MLLIBS))

OFILES       = $(addsuffix .o, $(LCFILES))
CFILES       = $(addsuffix .c, $(LCFILES))

RMLIFILES    = $(addprefix $(ROOT)/lib/, $(LMLIFILES))
RCMIFILES    = $(addprefix $(ROOT)/lib/, $(CMIFILES))
RCMAFILES    = $(addprefix $(ROOT)/lib/, $(addsuffix .cma, $(INSTALL_LIBS)))
RCMXAFILES   = $(addprefix $(ROOT)/lib/, $(addsuffix .cmxa, $(INSTALL_LIBS)))
RAFILES      = $(addprefix $(ROOT)/lib/, $(addsuffix .a, $(INSTALL_LIBS)))

ZMLFILES     = $(addsuffix .ml, $(MLZFILES))
ZMLIFILES    = $(addsuffix .mli, $(MLZFILES))
PMLFILES     = $(addsuffix _verb.ml, $(MLPFILES)) $(addsuffix _simp.ml, $(MLPFILES))
PMLIFILES    = $(addsuffix _verb.mli, $(MLPFILES)) $(addsuffix _simp.mli, $(MLPFILES))

# Instructions to make
.PHONY: all lib opt clean depend install
.PRECIOUS: %.cmo %.cmi %.cmx %.ml %.mli

.SUFFIXES: .cma .cmx .cmo .cmi .ml .mli .mll .mly

$(MAIN).a: $(OFILES)
	ar r $@ $?
	ranlib $@

$(MAIN).cma: $(LCMOFILES) $(NL_CMOFILES)
	$(OCAMLC) $(OCAMLCFLAGS) -a -o $@ $(LCMOFILES) $(NL_CMOFILES)

$(MAIN).cmxa: $(LCMXFILES) $(NL_CMXFILES)
	$(OCAMLOPT) $(OCAMLOPTFLAGS) -a -o $@ $(LCMXFILES) $(NL_CMXFILES)

$(MAIN).run: $(CMAFILES) $(CMADEPS) $(PCMOFILES)
	$(OCAMLCP) -custom $(OCAMLCFLAGS) -o $@ $(OCAMLCPOPT) $(CMALIBS) $(CMAFILES) $(PCMOFILES) $(CCLIBS) $(LIBTHREADS)
	if [ -f $(MAIN).run.exe ]; then\
		mv $(MAIN).run.exe $(MAIN).run.bak;\
		mv $(MAIN).run.bak $(MAIN).run;\
	fi

$(MAIN).opt: $(CMXAFILES) $(CMXDEPS) $(PCMXFILES)
	$(OCAMLOPT) $(OCAMLOPTFLAGS) -o $@ $(CMXAFILES) $(CMXLIBS) $(PCMXFILES) $(CCLIBS) $(LIBTHREADS)
	if [ -f $(MAIN).exe ]; then\
		mv $(MAIN).exe $(MAIN).bak;\
		mv $(MAIN).bak $(MAIN);\
	fi

#
# No default action for install
#
install::

$(RMLIFILES): $(ROOT)/lib/%.mli: %.mli
	$(LN) ../$(DIR)/$*.mli $(ROOT)/lib

$(RCMIFILES): $(ROOT)/lib/%.cmi: %.cmi
	$(LN) ../$(DIR)/$*.cmi $(ROOT)/lib

$(RCMAFILES): $(ROOT)/lib/%.cma: %.cma
	$(LN) ../$(DIR)/$*.cma $(ROOT)/lib

$(RCMXAFILES): $(ROOT)/lib/%.cmxa: %.cmxa
	$(LN) ../$(DIR)/$*.cmxa $(ROOT)/lib
	$(LN) ../$(DIR)/$*.a $(ROOT)/lib

$(RAFILES): $(ROOT)/lib/%.a: %.a
	$(LN) ../$(DIR)/$*.a $(ROOT)/lib

$(NL_CMIFILES) $(NL2_CMIFILES): %.cmi: %.mli
	$(PRLC) $(OCAMLCFLAGS) -c $*.mli

$(NL_PPOFILES) $(NL2_PPOFILES): %.ppo: %.cmi %.ml
	NLLIB=$(ROOT)/lib $(CAMLP4N) $(CAMLP4NFLAGS) $*.ml -o $*.ppo

$(NL_CMOFILES) $(NL2_CMOFILES): %.cmo: %.ppo %.cmi
	$(OCAMLC) $(OCAMLCFLAGS) -c -impl $*.ppo

$(NL_CMXFILES) $(NL2_CMXFILES): %.cmx: %.ppo %.cmi
	$(OCAMLOPT) $(OCAMLOPTFLAGS) -c -impl $*.ppo

$(REG_CMOFILES): %.cmo: %.ml %.cmi
	$(OCAMLCP) $(OCAMLCFLAGS) -c $(OCAMLCPOPT) $*.ml

$(REG_CMIFILES): %.cmi: %.mli
	$(OCAMLC) $(OCAMLCFLAGS) -c $*.mli

$(REG_CMXFILES): %.cmx: %.ml %.cmi
	$(OCAMLOPT) $(OCAMLOPTFLAGS) -c $*.ml

%.p4i: %.mli
	$(PRLC) $(INCLUDE) -E $*.mli > $*.p4i

%.p4: %.ml
	$(PRLC) $(INCLUDE) -E $*.ml > $*.p4

%.ml: %.mll
	rm -f $@
	$(OCAMLLEX) $*.mll

%.ml %.mli: %.mly
	rm -f $*.ml $*.mli
	$(OCAMLYACC) $*.mly

%.ml: %.mlz
	rm -f $@
	$(LN) $*.mlz $@

%.mli: %.mlz
	rm -f $@
	$(LN) $*.mlz $@

%_verb.ml: %.mlp $(ROOT)/refiner/refsig/refine_error.h
	rm -f $@
	$(CPP) $(INCLUDE) -DVERBOSE_EXN $*.mlp > $@
	chmod 444 $@

%_verb.mli: %.mlip
	rm -f $@
	$(CPP) $(INCLUDE) -DVERBOSE_EXN $*.mlip > $@
	chmod 444 $@

%_simp.ml: %.mlp $(ROOT)/refiner/refsig/refine_error.h
	rm -f $@
	$(CPP) $(INCLUDE) $*.mlp > $@
	chmod 444 $@

%_simp.mli: %.mlip
	rm -f $@
	$(CPP) $(INCLUDE) $*.mlip > $@
	chmod 444 $@

%.o: %.c
	$(CC) $(CFLAGS) -c $*.c

#
# Don't remove *.cmoz or *.cmot files because they
# may contain proofs.
#
clean::
	rm -f *.cmi* *.cmo *.z* *.o *.a *~ *.bak *.output $(CLEAN_MAIN)
	rm -f gmon.out $(ZMLFILES) $(ZMLIFILES) $(PMLFILES) $(PMLIFILES)

depend:: $(MLFILES) $(MLIFILES)
	rm -f Makefile.tmp
	touch Makefile.tmp
ifneq ($(MLFILES),)
	$(OCAMLDEP) -I $(CAMLLIB) $(OCAMLDEPFLAGS) $(INCLUDE) $(MLFILES) $(MLIFILES) >> Makefile.tmp
endif
ifneq ($(CFILES),)
	$(CC) $(CFLAGS) -MM $(CFILES) >> Makefile.tmp
endif
	mv Makefile.tmp Makefile.dep
