# -*- Mode: makefile -*-
#
# Script to generate a program.
# Assumes variables:
#    MFILES: root names of files
#    LMFILES: root names of library files
#    PFILES: root names of program files
#    MLLIBS: root name of libraries
#    MAIN: root name of generated program
#

#
# Config
#
ifndef LOCALBIN
   LOCALBIN := /usr/local/bin
endif

#
# OCAML commands
#
ifndef CAMLP4
   CAMLP4 := camlp4o
endif
ifndef OCAMLC
   OCAMLC := ocamlc
endif
ifndef OCAMLOPT
   OCAMLOPT := ocamlopt
endif
ifndef PRLC
   PRLC := prlc
endif

OCAMLDEP := ocamldep
OCAMLCFLAGS := $(INCLUDE) -g $(OCAMLFLAGS)
OCAMLOPTFLAGS := $(INCLUDE) $(OCAMLFLAGS)
CAMLP4OFLAGS := $(INCLUDE)
CFLAGS = -g -I$(CAMLLIB)
CC = gcc
RM = rm
INSTALL = install

# Library file names
MLFILES      := $(addsuffix .ml,   $(NLFILES) $(LMFILES) $(MFILES) $(PFILES))
MLIFILES     := $(addsuffix .mli,  $(NLFILES) $(LMFILES) $(MFILES) $(PFILES))

NL_CMIFILES  := $(addsuffix .cmi,  $(NLFILES))
NL_CMOFILES  := $(addsuffix .cmo,  $(NLFILES))
NL_CMIZFILES := $(addsuffix .cmiz, $(NLFILES))
NL_CMOZFILES := $(addsuffix .cmoz, $(NLFILES))
NL_CMXFILES  := $(addsuffix .cmx,  $(NLFILES))

LCMOFILES    := $(addsuffix .cmo,  $(LMFILES))
LCMIFILES    := $(addsuffix .cmi,  $(LMFILES))
LCMXFILES    := $(addsuffix .cmx,  $(LMFILES))
MCMIFILES    := $(addsuffix .cmi,  $(MFILES))
MCMOFILES    := $(addsuffix .cmo,  $(MFILES))
MCMXFILES    := $(addsuffix .cmx,  $(MFILES))
PCMIFILES    := $(addsuffix .cmi,  $(PFILES))
PCMOFILES    := $(addsuffix .cmo,  $(PFILES))
PCMXFILES    := $(addsuffix .cmx,  $(PFILES))

LMLIFILES    = $(addsuffix .mli,  $(LMFILES))
LMLFILES     = $(addsuffix .ml,   $(LMFILES))
MMLFILES     = $(addsuffix .mli,  $(MFILES))
MMLIFILES    = $(addsuffix .ml,   $(MFILES))
PMLIFILES    = $(addsuffix .mli,  $(PFILES))
PMLFILES     = $(addsuffix .ml,   $(PFILES))

REG_CMIFILES := $(LCMIFILES) $(MCMIFILES) $(PCMIFILES)
REG_CMOFILES := $(LCMOFILES) $(MCMOFILES) $(PCMOFILES)
REG_CMXFILES := $(LCMXFILES) $(MCMXFILES) $(PCMXFILES)

CMIFILES     := $(NL_CMIFILES) $(LCMIFILES) $(MCMIFILES)
CMOFILES     := $(NL_CMOFILES) $(LCMOFILES) $(MCMOFILES)
CMXFILES     := $(NL_CMXFILES) $(LCMXFILES) $(MCMXFILES)

CMAFILES     := $(addsuffix .cma,  $(MLLIBS))
CMXAFILES    := $(addsuffix .cmxa, $(MLLIBS))

OFILES       := $(addsuffix .o, $(LCFILES))
CFILES       := $(addsuffix .c, $(LCFILES))

# Instructions to make
.PHONY: all opt clean depend install
.PRECIOUS: %.cmo %.cmi %.cmx %.ml %.mli

.SUFFIXES: .cma .cmx .cmo .cmi .ml .mli .mll .mly

$(MAIN).a: $(OFILES)
	ar r $@ $?
	ranlib $@

$(MAIN).cma: $(LCMOFILES) $(NL_CMOFILES)
	$(OCAMLC) $(OCAMLCFLAGS) -a -o $@ $(LCMOFILES) $(NL_CMOFILES)

$(MAIN).cmxa: $(LCMXFILES) $(ML_CMXFILES)
	$(OCAMLOPT) $(OCAMLCFLAGS) -o -o $@ $(LCMXFILES) $(NL_CMXFILES)

$(MAIN).run: $(CMAFILES) $(CMADEPS) $(PCMOFILES)
	$(OCAMLC) -custom $(OCAMLCFLAGS) -o $@ $(CMALIBS) $(CMAFILES) $(PCMOFILES) $(CCLIBS)
	if [ -f $(MAIN).run.exe ]; then\
		mv $(MAIN).run.exe $(MAIN).run.bak;\
		mv $(MAIN).run.bak $(MAIN).run;\
	fi

$(MAIN): $(CMXAFILES) $(CMXDEPS) $(PCMXFILES)
	$(OCAMLOPT) $(OCAMLCFLAGS) -o $@ $(CMXAFILES) $(CMXLIBS) $(PCMXFILES) $(CCLIBS)
	if [ -f $(MAIN).exe ]; then\
		mv $(MAIN).exe $(MAIN).bak;\
		mv $(MAIN).bak $(MAIN);\
	fi

#
# No default action for install
#
install::

$(NL_CMOFILES): %.cmo: %.ml %.cmi
	$(PRLC) $(OCAMLCFLAGS) -c $*.ml

$(NL_CMIFILES): %.cmi: %.mli
	$(PRLC) $(OCAMLCFLAGS) -c $*.mli

$(NL_CMXFILES): %.cmx: %.ml $.mli
	$(PRLC) $(OCAMLOPTFLAGS) -c $*.ml

$(REG_CMOFILES): %.cmo: %.ml %.cmi
	$(OCAMLC) $(OCAMLCFLAGS) -c $*.ml

$(REG_CMIFILES): %.cmi: %.mli
	$(OCAMLC) $(OCAMLCFLAGS) -c $*.mli

$(REG_CMXFILES): %.cmx: %.ml $.mli
	$(OCAMLOPT) $(OCAMLOPTFLAGS) -c $*.ml

%.p4i: %.mli
	$(PRLC) $(INCLUDE) -E $*.mli > $*.p4i

%.p4: %.ml
	$(PRLC) $(INCLUDE) -E $*.ml > $*.p4

%.ml: %.mll
	rm -f $@
	$(OCAMLLEX) $*.mll
	chmod 444 $@

%.ml %.mli: %.mly
	rm -f $*.ml $*.mli
	$(OCAMLYACC) $*.mly
	chmod 444 $*.ml $*.mli

%.ml: %.mlz
	rm -f $@
	cp $*.mlz $@
	chmod 444 $@

%.mli: %.mlz
	rm -f $@
	cp $*.mlz $@
	chmod 444 $@

%.o: %.c
	$(CC) $(CFLAGS) -c $*.c

clean::
	rm -f *.cm* *.z* *.o *~ *.bak *.output $(MAIN) $(MAIN).run

depend:: $(MLFILES) $(MLIFILES)
	rm -f Makefile.tmp
	touch Makefile.tmp
ifneq ($(MLFILES),)
	$(OCAMLDEP) $(INCLUDE) $(MLFILES) $(MLIFILES) >> Makefile.tmp
endif
ifneq ($(CFILES),)
	$(CC) $(CFLAGS) -MM $(CFILES) >> Makefile.tmp
endif
	mv Makefile.tmp Makefile.dep
