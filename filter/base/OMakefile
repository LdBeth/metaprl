#
# Type files
#
include Files

OCamlLibraryInstall($(MPINSTALL), $(LIB), filterbase, $(BASE_FILES))

########################################################################
# Magic numbers
#

#
# Generate magic numbers for a set of files.
# The text for the magic numbers is delimited by lines
# containing %%MAGICBEGIN%% and %%MAGICEND%%.
#
ExtractMagicLines(file, files) =
   stdout = $(fopen $(file), wb)

   print = false

   awk($(files))
   case $'%%MAGICEND%%'
      print = false
      export
   default
      if $(print)
         println($0)
   case $'%%MAGICBEGIN%%'
      print = true
      export

   close($(stdout))

ExtractMagic(in, out) =
   stdout = $(fopen $(out), w)
   awk($(in))
   case $'FILTER_MD5:'
      print($(nth $(sub $(NF), 1), $*))
   close($(stdout))

#
# Magic text for the grammars.
#
FILTER_MAGIC[] =
    $(ROOT)/libmojave/util/lm_hash.ml
    $(ROOT)/libmojave/util/lm_lexer.ml
    $(ROOT)/libmojave/util/lm_parser.ml
    $(ROOT)/refiner/rewrite/rewrite_types.ml
    $(ROOT)/refiner/refsig/term_sig.ml
    $(ROOT)/refiner/term_ds/term_ds_sig.ml
    $(ROOT)/refiner/reflib/ascii_io.ml
    filter_type.ml
    filter_grammar.ml

filter_magic.cmo: .magic
filter_magic.cmx filter_magic$(EXT_OBJ): .magic

.magic.txt: $(FILTER_MAGIC)
   ExtractMagicLines($@, $+)

if $(not $(defined CHECK_MAGIC))
    CHECK_MAGIC = true
    export

.magic: .magic.txt filter_magic.ml
   section eval
      NEW_MAGIC = $(digest .magic.txt)
      ExtractMagic(filter_magic.ml, $@)
      OLD_MAGIC = $(cat $@)
      if $(and $(CHECK_MAGIC), $(not $(equal $(NEW_MAGIC), $(OLD_MAGIC))))
         eprintln(!!! )
         eprintln(!!! The FILTER_MD5 digest recorder in the filter/base/filter_magic.ml file)
         eprintln(!!! does not match the computed one!)
         eprintln(!!! The filter/base/filter_magic.ml file needs to be updated.)
         eprintln(!!! )
         eprintln(!!! Recorded hash - $(OLD_MAGIC); computed hash - $(NEW_MAGIC))
         exit(1)

#
# Clean up
#
clean:
    $(CLEAN) .magic .magic.txt

all: filterbase$(LIB_SUFFIX)
