# Shared files
MLZFILES =\
    asttypes\
    parser_aux

PFILES_SRC =\
    $(MLZFILES)\
    ident\
    config\
    misc\
    tbl\
    primitive\
    path\
    types\
    btype\
    subst\
    predef\
    datarepr\
    env\
    lambda\
    instruct\
    opcodes\
    clflags\
    typedtree\
    ctype\
    typeopt\
    terminfo\
    linenum\
    location\
    matching\
    translobj\
    translcore\
    translclass\
    translmod\
    meta\
    emitcode\
    runtimedef\
    symtable\
    debugger_config\
    primitives\
    lexer\
    input_handling\
    parser\
    debugcom\
    symbols\
    debug

PFILES_NONE =

PFILES = $(if $(equal $(OCAMLSRC), undefined), $(PFILES_NONE), $(PFILES_SRC))

#
# Standard library files
#
LMFILES =\
    debug_symbols

OCamlLibrary(ldsymbols, $(LMFILES))

#
# Rules
#
DEBUG_FILES =\
	debugger_config\
	primitives\
	input_handling\
	debugcom\
	symbols\
	parser

TYPING_FILES =\
	env\
	path\
	types\
	subst\
	btype\
	predef\
	datarepr\
	primitive\
	ident\
	typedtree\
	ctype

BYTECOMP_FILES =\
	lambda\
	instruct\
	typeopt\
	matching\
	translclass\
	translcore\
	translobj\
	translmod\
	meta\
	emitcode\
	runtimedef\
	symtable

UTIL_FILES =\
	tbl\
	config\
	misc\
	terminfo

PARSING_FILES =\
	linenum\
	location

asttypes.mlz: $(OCAMLSRC)/parsing/asttypes.mli
	$(LN) -f $(OCAMLSRC)/parsing/asttypes.mli $@

parser_aux.mlz: $(OCAMLSRC)/debugger/parser_aux.mli
	$(LN) -f $(OCAMLSRC)/debugger/parser_aux.mli $@

opcodes.ml: $(OCAMLSRC)/bytecomp/opcodes.ml
	$(LN) -f $(OCAMLSRC)/bytecomp/opcodes.ml $@

opcodes.mli: opcodes.ml
	sed -e 's,let \(.*\)=.*,val \1 : int,' < opcodes.ml > opcodes.mli

clflags.ml: $(OCAMLSRC)/utils/clflags.ml
	$(LN) -f $(OCAMLSRC)/utils/clflags.ml $@

clflags.mli: clflags.ml
	$(OCAMLC) $(OCAMLCFLAGS) -i clflags.ml > clflags.mli

lexer.ml: $(OCAMLSRC)/debugger/lexer.ml
	$(LN) -f $(OCAMLSRC)/debugger/lexer.ml $@

lexer.mli: lexer.ml
	$(OCAMLC) $(OCAMLCFLAGS) -i lexer.ml > lexer.mli

$(addsuffix .ml, $(DEBUG_FILES)): %.ml: $(OCAMLSRC)/debugger/%.ml
	$(LN) -f $(OCAMLSRC)/debugger/$*.ml $@

$(addsuffix .mli, $(DEBUG_FILES)): %.mli: $(OCAMLSRC)/debugger/%.mli
	$(LN) -f $(OCAMLSRC)/debugger/$*.mli $@

$(addsuffix .ml, $(TYPING_FILES)): %.ml: $(OCAMLSRC)/typing/%.ml
	$(LN) -f $(OCAMLSRC)/typing/$*.ml $@

$(addsuffix .mli, $(TYPING_FILES)): %.mli: $(OCAMLSRC)/typing/%.mli
	$(LN) -f $(OCAMLSRC)/typing/$*.mli $@

$(addsuffix .ml, $(BYTECOMP_FILES)): %.ml: $(OCAMLSRC)/bytecomp/%.ml
	$(LN) -f $(OCAMLSRC)/bytecomp/$*.ml $@

$(addsuffix .mli, $(BYTECOMP_FILES)): %.mli: $(OCAMLSRC)/bytecomp/%.mli
	$(LN) -f $(OCAMLSRC)/bytecomp/$*.mli $@

$(addsuffix .ml, $(UTIL_FILES)): %.ml: $(OCAMLSRC)/utils/%.ml
	$(LN) -f $(OCAMLSRC)/utils/$*.ml $@

$(addsuffix .mli, $(UTIL_FILES)): %.mli: $(OCAMLSRC)/utils/%.mli
	$(LN) -f $(OCAMLSRC)/utils/$*.mli $@

$(addsuffix .ml, $(PARSING_FILES)): %.ml: $(OCAMLSRC)/parsing/%.ml
	$(LN) -f $(OCAMLSRC)/parsing/$*.ml $@

$(addsuffix .mli, $(PARSING_FILES)): %.mli: $(OCAMLSRC)/parsing/%.mli
	$(LN) -f $(OCAMLSRC)/parsing/$*.mli $@

#
# Clean up
#
clean:
    $(CLEAN)
